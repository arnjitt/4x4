<!DOCTYPE html>
<html>
<head>
<title>Plan {{ event_name }}</title>
<style>
body { font-family: sans-serif; margin: 0; padding: 16px; }
h1 { margin-bottom: 16px; }

.layout { display: flex; gap: 16px; }

.friends-list { flex: 1; }

.roles { 
    flex: 2;
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
}

.friend-item {
    padding: 4px 6px;
    margin-bottom: 4px;
    border: 2px solid #ccc;
    border-radius: 4px;
    background: #fff;
    cursor: grab;
    font-size: 0.9rem;
    max-width: 160px;           /* keeps the pill small */
    white-space: nowrap;        /* single line */
    overflow: hidden;           /* hide overflow */
    text-overflow: ellipsis;    /* show “…” if too long */
}

.role-box {
    flex: 1 1 calc(33.33% - 12px);
    border: 2px dashed #bbb;
    border-radius: 6px;
    padding: 8px;
    min-height: 80px;
    box-sizing: border-box;
}

.role-box.active {
    border-color: #1976d2;
    background: #e3f2fd;
}

.role-title {
    font-weight: bold;
    margin-bottom: 4px;
}
.friend-item.returning {
	transition: transform 0.25s ease-out, opacity 0.25s ease-out;
	transform: translateX(-10px);
	opacity:0;
}
.friend-item.returning.show {
	transform: translateX(0);
	opacity: 1;
}
</style>
</head>
<body>
  <h1>Plan: {{ event_name }}</h1>
  <p>Drag friends into roles for this trip.</p>

  <div class="layout">
    <div class="friends-list">
      <h3>Available Friends</h3>
      <div id="friendsPool">
        {% for friend, color in friends_with_colors %}
          <div class="friend-item"
               draggable="true"
               id="friend-{{ friend.id }}"
			   data-friend-id="{{ friend.id }}"
               style="border-color: {{ color }}; background-color: {{ color }}20;">
            <span style="color: {{ color }};">{{ friend.name }}</span>
          </div>
        {% empty %}
          <p>No friends yet. Add some first.</p>
        {% endfor %}
      </div>
    </div>

    <div class="roles">
      <h3 style="flex-basis:100%;">Roles for Basketball Trip</h3>

      <div class="role-box" data-role="driver">
        <div class="role-title">Driver</div>
      </div>

      <div class="role-box" data-role="bring_x">
        <div class="role-title">Bringing Snacks</div>
      </div>

      <div class="role-box" data-role="bring_y">
        <div class="role-title">Bringing Drinks</div>
      </div>

      <!-- Carpool bins also participate in the 3-wide layout -->
    </div>
  </div>
  	<h3>Carpools</h3>
	<ul id="carpoolsList">
		{% for car in carpools %}
			<li class="role-box carpool-box"
				data-role="carpool"
				data-carpool-id="{{ car.id }}">
				<div class="role-title">
					<strong>{{ car.driver.name }}</strong>'s car (seats: {{ car.seats }}):
				</div>
				{% for rider in car.riders.all %}
					<div class="friend-item"
						draggable="true"
						id="friend-{{ rider.friend.id }}"
						data-friend-id="{{ rider.friend.id }}">
					{{ rider.friend.name }}
					</div>
				{% endfor %}
			</li>
		{% empty %}
		<li> No Carpools created for this event.</li>
		{% endfor %}
	</ul>

  <p><a href="{% url 'chat_room' %}">Back to chat</a></p>

  <button id="carpoolSummaryBtn">Show carpool summary</button>
<hr>
{% include "website/_mini_chat.html" %}
</body>
<script>
  function getNames(container) {
      return Array.from(container.querySelectorAll('.friend-item'))
                  .map(el => el.textContent.trim());
  }

    const friendItems = document.querySelectorAll('.friend-item');
    const roleBoxes = document.querySelectorAll('.role-box');

    let draggedId = null;

    friendItems.forEach(item => {
        item.addEventListener('dragstart', (e) => {
            draggedId = e.target.id;
            e.dataTransfer.setData('text/plain', draggedId);
        });
    });

    roleBoxes.forEach(box => {
		box.addEventListener('dragover', (e) => {
			e.preventDefault();
			box.classList.add('active')
		});

		box.addEventListener('dragleave', () => {
			box.classList.remove('active');
		});

        box.addEventListener('drop', async (e) => {
			e.preventDefault();
			box.classList.remove('active');
			const id = e.dataTransfer.getData('text/plain') || draggedId;
			const friendEl = document.getElementById(id);
			if (friendEl) {
				box.appendChild(friendEl);
				if (box.dataset.role === "carpool") {
					await saveCarpool(box);
				}
			}
		});
    });

    // Optional: allow dragging back to pool
    const pool = document.getElementById('friendsPool');
    pool.addEventListener('dragover', (e) => e.preventDefault());
    pool.addEventListener('drop', (e) => {
        e.preventDefault();
        const id = e.dataTransfer.getData('text/plain') || draggedId;
        const friendEl = document.getElementById(id);
        if (friendEl) {
            pool.appendChild(friendEl);
        }
    });
	
	async function saveCarpool(carpoolBox) {
		const carpoolId = carpoolBox.dataset.carpoolId;
		const friendIds = Array.from(
			carpoolBox.querySelectorAll(".friend-item")
		).map(el => parseInt(el.dataset.friendId,10));
		
		await fetch("{% url 'update_carpool_riders' %}", {
			method: "POST",
			headers: {
				"Content-Type": "application/json",
				"X-CSRFToken": "{{ csrf_token }}",
			},
			body: JSON.stringify({
				carpool_id: parseInt(carpoolId, 10),
				friend_ids: friendIds,
			}),
		});
	}

	document.addEventListener("click", (e) => {
		const friendEl = e.target.closest(".friend-item");
		if (!friendEl) return;

		const pool = document.getElementById("friendsPool");
		if (!pool.contains(friendEl)) {
			pool.appendChild(friendEl);
		}
	})
</script>
</html>
